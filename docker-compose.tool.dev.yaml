services:
  tool-traefik:
    container_name: tool-traefik
    image: traefik
    ports:
      - '80:80'
      - '443:443'
    restart: unless-stopped
    env_file: ./.env
    command:
      - --providers.docker=true
      - --api.dashboard=true
      - --providers.docker.exposedbydefault=false

      - --certificatesresolvers.letsencrypt.acme.dnschallenge=true
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.provider=cloudflare
      - --certificatesResolvers.letsencrypt.acme.dnschallenge.delayBeforeCheck=20
      - --certificatesresolvers.letsencrypt.acme.email=${SSL_EMAIL}
      - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json

      - --entrypoints.http.address=:80
      - --entrypoints.http.http.redirections.entrypoint.to=https
      - --entrypoints.http.http.redirections.entrypoint.scheme=https

      - --entryPoints.https.address=:443
      - --entrypoints.https.http.tls=true
      - --entrypoints.https.http.tls.certResolver=letsencrypt
      - --entrypoints.https.http.tls.domains[0].main=${DOMAIN}
      - --entrypoints.https.http.tls.domains[0].sans=*.${DOMAIN}
    volumes:
      - ./.volume/tool-traefik:/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock:ro

  tool-n8n:
    container_name: tool-n8n
    build:
      context: ./packages/tool-n8n
      dockerfile: Dockerfile
    ports:
      - '5678:5678'
    restart: unless-stopped
    env_file:
      - ./packages/tool-n8n/.base.env
      - ./packages/tool-n8n/.prod.env
    labels:
      - traefik.enable=true
      - traefik.http.routers.tool-n8n.rule=Host(`tool-n8n.${DOMAIN}`)
      - traefik.http.routers.tool-n8n.tls=true
      - traefik.http.routers.tool-n8n.entrypoints=https
      - traefik.http.routers.tool-n8n.tls.certresolver=letsencrypt
      - traefik.http.routers.tool-n8n.middlewares=tool-n8n@docker
      - traefik.http.middlewares.tool-n8n.headers.SSLRedirect=true
      - traefik.http.middlewares.tool-n8n.headers.STSSeconds=315360000
      - traefik.http.middlewares.tool-n8n.headers.browserXSSFilter=true
      - traefik.http.middlewares.tool-n8n.headers.contentTypeNosniff=true
      - traefik.http.middlewares.tool-n8n.headers.forceSTSHeader=true
      - traefik.http.middlewares.tool-n8n.headers.SSLHost=${DOMAIN}
      - traefik.http.middlewares.tool-n8n.headers.STSIncludeSubdomains=true
      - traefik.http.middlewares.tool-n8n.headers.STSPreload=true
      - traefik.http.services.tool-n8n.loadbalancer.server.port=5678
      - traefik.http.services.tool-n8n.loadbalancer.server.scheme=http
      - traefik.http.services.tool-n8n.loadbalancer.passHostHeader=true
    volumes:
      - ./.volume/tool-n8n:/home/node/.n8n
      - ./.volume/local-files:/files
